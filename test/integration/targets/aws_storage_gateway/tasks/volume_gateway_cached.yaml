---
- name: set connection information for all tasks
  set_fact:
    aws_connection_info: &aws_connection_info
      aws_access_key: "{{ aws_access_key }}"
      aws_secret_key: "{{ aws_secret_key }}"
      region: "{{ aws_region }}"
  no_log: true

- name: Create storage gateway instance
  ec2_instance:
    name: "{{ resource_prefix }}-test-default-vpc"
    image_id: "{{ ec2_vol_vtl_ami_image[aws_region] }}"
    tags:
      TestId: "{{ resource_prefix }}"
    security_groups: "{{ sg.group_id }}"
    vpc_subnet_id: "{{ testing_subnet.subnet.id }}"
    network:
      assign_public_ip: true
    instance_type: m4.xlarge
    volumes:
      - device_name: /dev/sdb
        ebs:
          volume_size: 150
          delete_on_termination: true
          volume_type: standard
      - device_name: /dev/sdc
        ebs:
          volume_size: 150
          delete_on_termination: true
          volume_type: standard
    <<: *aws_connection_info
  register: gateway_instance

- name: Send storage gateway activation code request
  uri:
    url: "http://{{ gateway_instance.instances[0].public_ip_address }}/?activationRegion={{ aws_region }}"
  retries: 10
  register: code_request

- name: Extract activation code from request
  shell: echo "{{ code_request.url }}" | awk -F'[=&]' '{print $2}'
  register: activation_code

- name: remove storage gateway instance
  ec2_instance:
    filters:
      name: "{{ resource_prefix }}-test-default-vpc"
    state: absent
    <<: *aws_connection_info
  register: removed
  until: removed is not failed
  ignore_errors: yes
  retries: 10
