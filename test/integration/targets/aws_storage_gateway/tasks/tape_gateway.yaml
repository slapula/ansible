---
- block:
  - name: VTL -- set connection information
    set_fact:
      aws_connection_info: &aws_connection_info
        aws_access_key: "{{ aws_access_key }}"
        aws_secret_key: "{{ aws_secret_key }}"
        region: "{{ aws_region }}"
    no_log: true

  - name: VTL -- Generate random barcode for test tape
    set_fact:
      barcode: "{{ 100000 | random }}"
    run_once: yes

  - name: VTL -- Create storage gateway instance
    ec2_instance:
      name: "{{ resource_prefix }}-test-tape-gateway"
      image_id: "{{ ec2_vol_vtl_ami_image[aws_region] }}"
      tags:
        TestId: "{{ resource_prefix }}"
      security_groups: "{{ sg.group_id }}"
      vpc_subnet_id: "{{ testing_subnet.subnet.id }}"
      network:
        assign_public_ip: true
      instance_type: m4.xlarge
      volumes:
        - device_name: /dev/sdb
          ebs:
            volume_size: 150
            delete_on_termination: true
            volume_type: standard
        - device_name: /dev/sdc
          ebs:
            volume_size: 150
            delete_on_termination: true
            volume_type: standard
      <<: *aws_connection_info
    register: gateway_instance

  - name: VTL -- Send storage gateway activation code request
    uri:
      url: "http://{{ gateway_instance.instances[0].public_ip_address }}/?activationRegion={{ aws_region }}"
    retries: 10
    register: code_request

  - name: VTL -- Extract activation code from request
    shell: echo "{{ code_request.url }}" | awk -F'[=&]' '{print $2}'
    register: activation_code

  - name: VTL -- Activate VTL storage gateway
    aws_storage_gateway:
      name: test_vtl_gateway
      state: present
      resource_type: gateway
      activation_key: "{{ activation_code.stdout }}"
      timezone: 'GMT-6:00'
      gateway_region: "{{ aws_region }}"
      gateway_type: 'VTL'
      tape_drive_type: 'IBM-ULT3580-TD5'
      medium_changer_type: 'AWS-Gateway-VTL'
      <<: *aws_connection_info
    register: vtl_gateway

  - name: VTL -- Create virtual tape
    aws_storage_gateway:
      state: present
      resource_type: tape
      gateway_arn: "{{ vtl_gateway.results['GatewayARN'] }}"
      tape_size: 536870912000
      tape_barcode: "ANBL{{ barcode }}"
      <<: *aws_connection_info

  always:
  - name: VTL -- Destroy virtual tape
    aws_storage_gateway:
      state: absent
      resource_type: tape
      gateway_arn: "{{ vtl_gateway.results['GatewayARN'] }}"
      tape_size: 536870912000
      tape_barcode: "ANBL{{ barcode }}"
      <<: *aws_connection_info
    register: removed
    until: removed is not failed
    ignore_errors: yes
    retries: 5

  - name: VTL -- Deactivate VTL storage gateway
    aws_storage_gateway:
      name: test_vtl_gateway
      state: absent
      resource_type: gateway
      activation_key: "{{ activation_code.stdout }}"
      timezone: 'GMT-6:00'
      gateway_region: "{{ aws_region }}"
      gateway_type: 'VTL'
      tape_drive_type: 'IBM-ULT3580-TD5'
      medium_changer_type: 'AWS-Gateway-VTL'
      <<: *aws_connection_info
    register: removed
    until: removed is not failed
    ignore_errors: yes
    retries: 5
